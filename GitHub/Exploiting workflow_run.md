## What is workflow_run?
A special GitHub Actions trigger that allows one workflow to be triggered after another completes
```yml
on:
	workflow_run:
		workflows: ["Build"] 
		types:
		- completed
```
- Used for chaining workflows, like Build ➝ Test ➝ Deploy.
- Runs in the context of the repository that owns the workflow, not the origin of the trigger

## Where the Exploit Comes In?
If the initial workflow (Build) is run based on untrusted code (like a PR from a fork) and its artifacts or outputs are used blindly in the next workflow, attackers can poison what gets consumed in the next step

## Exploitation Scenario
1. Attacker forks the repo and opens a PR with a malicious file
2. PR triggers a Build workflow (allowed via pull_request)
3. Build workflow uploads a malicious artifact
4. The main repo has a workflow_run trigger for Build
5. That second workflow downloads and runs the malicious artifact now in the trusted context

## Example
```yml
name: Non Privileged Workflow 

on: 
 pull_request: 
   branches: 
     - main 

permissions: 
 contents: read 

jobs: 
 test: 
   runs-on: ubuntu-latest 
   steps: 
     - name: Checkout Code 
       uses: actions/checkout@v2 
     - name: Run Tests 
       run: npm run test
```

```yml
name: Privileged Workflow Running npm Scripts

on:
  workflow_run:
    workflows: ["Non Privileged Workflow"]
    types:
      - completed

permissions:
  contents: write 

jobs:
  privileged-npm-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.workflow_run.repository.full_name }}
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install Dependencies
        run: npm install

      - name: List important files
        run: ls ./important-files

      - name: Run Custom npm Script from package.json
        run: npm run build

      - name: List important files
        run: ls ./important-files
```
This involves two workflows:
- PR Workflow Trigger: a non-privileged workflow triggered by a PR
- Privileged Workflow: a 'workflow_run' that checks out the PR code and runs custom scripts with elevated permissions
The vulnerability arises when the privileged workflow runs untrusted code from the forked PR.

### Workflow
1. This workflow, named "**Non Privileged Workflow**", is triggered when a pull request targets the main branch. It runs with **read-only** permissions on repository contents to limit potential impact. The workflow checks out the code and runs a testing script using **npm run test** on an Ubuntu runner. While this workflow itself is not dangerous, it becomes risky when it triggers a privileged workflow in a chained setup.
2. This privileged workflow is triggered automatically when the “**Non Privileged Workflow**” completes, using the workflow_run event. It is configured with write access to the repository, giving it elevated permissions compared to the initial workflow. Once triggered, it checks out the exact commit from the previously run workflow using the head_sha, **ensuring** the same codebase is reused.
3. The workflow sets up a Node.js environment (version 16), installs dependencies using **npm install**, and lists the contents of the **./important-files** directory. It then executes a custom script defined in the repository’s package.json file using **npm run build**. Finally, it again lists the contents of the ./important-files directory to observe any changes made by the build script.
4. The key risk here is that this privileged workflow blindly executes the build script from an untrusted pull request. If an attacker modifies the package.json in the non-privileged workflow, they can chain it to this one and run arbitrary commands with elevated permissions.
## Exploitation Scenario
1. The attacker submits a pull request with modified 'package.json' scripts.
2. The initial non-privileged workflow completes, triggering the privileged workflow.
3. The privileged workflow checks out the malicious code and executes the npm scripts, potentially compromising the CI/CD pipeline or stealing secrets

## Mitigation
To mitigate this vulnerability:
1. Avoid checking out untrusted code: Use 'head_sha' carefully or limit the privileged workflow to trusted code from the base repository.
2. Restrict permissions: Ensure that the token and permissions granted to workflows are minimized to the least privilege necessary.
3. Validate inputs and artifacts: Ensure that artifacts and inputs from non-privileged workflows are validated before use in a privileged workflow.
